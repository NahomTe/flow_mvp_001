<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Class Hub</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #050505;
        --card-bg: #111111;
        --accent: #3b82f6;
        --accent-glow: rgba(59, 130, 246, 0.3);
        --text-main: #ffffff;
        --text-dim: #888888;

        /* Subject Colors */
        --color-math: #3b82f6; /* Blue */
        --color-ent: #f59e0b; /* Orange */
        --color-tech: #8b5cf6; /* Purple */
        --color-eng: #10b981; /* Green */
        --color-civ: #14b8a6; /* Teal */
        --color-ant: #ec4899; /* Pink */
        --color-inc: #ef4444; /* Red */
      }

      body {
        margin: 0;
        font-family: "Inter", sans-serif;
        background: var(--bg);
        color: var(--text-main);
        padding: 16px;
        line-height: 1.5;
        padding-bottom: 60px; /* Extra space at bottom for easy scrolling */
      }

      /* COUNTDOWN SECTION */
      .countdown-card {
        background: linear-gradient(
          145deg,
          rgba(59, 130, 246, 0.15),
          rgba(0, 0, 0, 0)
        );
        border: 1px solid rgba(59, 130, 246, 0.3);
        box-shadow: 0 0 20px var(--accent-glow);
        border-radius: 16px;
        padding: 24px;
        text-align: center;
        margin-bottom: 30px;
      }

      .countdown-card h1 {
        font-size: 40px;
        margin: 0;
        font-weight: 700;
        letter-spacing: -1px;
      }

      .countdown-card p {
        color: var(--text-dim);
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 5px;
        margin-bottom: 0;
      }

      /* SCHEDULE CONTAINER */
      .schedule-container {
        display: flex;
        flex-direction: column;
        gap: 30px;
      }

      .day-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
        position: relative;
      }

      /* STICKY HEADERS */
      .day-header {
        position: sticky;
        top: 0;
        z-index: 10;
        background: rgba(5, 5, 5, 0.85);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        padding: 12px 0;
        font-size: 20px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 4px;
      }

      .today-badge {
        display: none;
        font-size: 11px;
        background: var(--accent);
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
      }

      .day-section.is-today .today-badge {
        display: block;
      }

      .day-section.is-today .day-header {
        color: var(--accent);
        border-bottom: 1px solid var(--accent);
      }

      /* CLASS CARDS */
      .class-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .class-card h4 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
      }

      .class-info {
        font-size: 14px;
        color: var(--text-dim);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      /* SUBJECT COLOR CODING */
      .subj-math {
        border-left: 4px solid var(--color-math);
      }
      .subj-ent {
        border-left: 4px solid var(--color-ent);
      }
      .subj-tech {
        border-left: 4px solid var(--color-tech);
      }
      .subj-eng {
        border-left: 4px solid var(--color-eng);
      }
      .subj-civ {
        border-left: 4px solid var(--color-civ);
      }
      .subj-ant {
        border-left: 4px solid var(--color-ant);
      }
      .subj-inc {
        border-left: 4px solid var(--color-inc);
      }

      .empty-day {
        background: transparent;
        border: 1px dashed rgba(255, 255, 255, 0.2);
        color: var(--text-dim);
        text-align: center;
        padding: 20px;
        border-radius: 12px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <!-- COUNTDOWN -->
    <div class="countdown-card" id="countdownCard">
      <h1 id="daysLeft">-- DAYS</h1>
      <p>Until Final Exam</p>
    </div>

    <!-- SCHEDULE LIST -->
    <div class="schedule-container" id="scheduleContainer">
      <div style="text-align: center; padding: 50px; color: var(--text-dim)">
        Updating schedule...
      </div>
    </div>

    <script>
      const API_URL =
        "https://script.google.com/macros/s/AKfycbw6sJSMVoTyaYrYA1Ibh0VuCd6SWW-mThbowo8xjnPsQTG-_RV6_1zRMQfB2wGb2cAS0g/exec";
      const examDate = new Date("2026-06-01T09:00:00");

      // 1. FETCH DATA FROM YOUR SHEET
      async function loadSchedule() {
        const container = document.getElementById("scheduleContainer");
        try {
          const response = await fetch(API_URL);
          const data = await response.json();
          container.innerHTML = "";

          for (let i = 1; i <= 5; i++) {
            let dayClasses = data.filter((row) => row.DayID == i);

            // --- NEW SORTING LOGIC ---
            dayClasses.sort((a, b) => {
              return convertToMinutes(a.Time) - convertToMinutes(b.Time);
            });
            // -------------------------

            renderDay(i, dayClasses, container);
          }
          highlightAndScrollToday();
        } catch (err) {
          container.innerHTML = `<div class="empty-day">‚ö†Ô∏è Failed to load schedule.</div>`;
        }
      }

      // Helper function to turn "10:30 AM" into a sortable number (minutes)
      function convertToMinutes(timeString) {
        if (!timeString) return 0;

        // Matches "10:30" and "AM" separately
        const match = timeString.match(/(\d+):(\d+)\s*(AM|PM)/i);
        if (!match) return 0;

        let [, hours, minutes, period] = match;
        hours = parseInt(hours);
        minutes = parseInt(minutes);

        // Convert to 24-hour format for sorting
        if (period.toUpperCase() === "PM" && hours !== 12) hours += 12;
        if (period.toUpperCase() === "AM" && hours === 12) hours = 0;

        return hours * 60 + minutes;
      }

      // 2. CREATE THE HTML CARDS
      function renderDay(dayId, classes, container) {
        const dayNames = [
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
        ];
        let html = `
    <div class="day-section" data-day="${dayId}">
      <div class="day-header">
        ${dayNames[dayId - 1]} <span class="today-badge">Today</span>
      </div>`;

        if (classes.length === 0) {
          html += `<div class="empty-day">‚òï No classes scheduled today</div>`;
        } else {
          classes.forEach((cls) => {
            html += `
        <div class="class-card ${getSubjectClass(cls.Subject)}">
          <h4>${cls.Subject}</h4>
          <div class="class-info">üïí ${cls.Time} ${cls.RoomNumber ? "| üìç " + cls.RoomNumber : ""}</div>
        </div>`;
          });
        }

        html += `</div>`;
        container.innerHTML += html;
      }

      // 3. COLOR LOGIC
      function getSubjectClass(subject) {
        const s = subject.toLowerCase();
        if (s.includes("math")) return "subj-math";
        if (s.includes("entrepreneur")) return "subj-ent";
        if (s.includes("tech")) return "subj-tech";
        if (s.includes("eng")) return "subj-eng";
        if (s.includes("civic")) return "subj-civ";
        if (s.includes("anthrop")) return "subj-ant";
        if (s.includes("inclu")) return "subj-inc";
        return "";
      }

      // 4. REMAINING UTILITIES
      function updateCountdown() {
        const now = new Date();
        const diff = examDate - now;
        if (diff <= 0) {
          document.getElementById("daysLeft").textContent = "EXAM DAY";
          return;
        }
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        document.getElementById("daysLeft").textContent = `${days} DAYS`;
      }

      function highlightAndScrollToday() {
        const today = new Date().getDay();
        const todaySection = document.querySelector(
          `.day-section[data-day="${today}"]`,
        );
        if (todaySection) {
          todaySection.classList.add("is-today");
          setTimeout(() => {
            todaySection.scrollIntoView({ behavior: "smooth", block: "start" });
          }, 500);
        }
      }

      // INITIALIZE
      document.addEventListener("DOMContentLoaded", () => {
        loadSchedule();
        setInterval(updateCountdown, 1000);
        updateCountdown();

        if (window.Telegram?.WebApp) {
          window.Telegram.WebApp.ready();
          window.Telegram.WebApp.expand();
          window.Telegram.WebApp.setHeaderColor("#050505");
        }
      });
    </script>
  </body>
</html>
